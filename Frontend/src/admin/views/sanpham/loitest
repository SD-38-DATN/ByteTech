<template>
  <div class="container-fluid py-4 px-md-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0">Quản lý Sản phẩm</h2>
        <span class="badge bg-primary-subtle text-primary border fs-6">
          {{ totalSanPhams }} sản phẩm
        </span>
      </div>
      <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
        <button class="btn btn-outline-secondary" @click="reload">
          <i class="bi bi-arrow-clockwise me-2"></i>Tải lại
        </button>
        <button class="btn btn-primary" @click="openSanPhamForm()">
          <i class="bi bi-plus-circle me-2"></i>Thêm sản phẩm mới
        </button>
      </div>
    </div>

    <div v-if="isSanPhamFormVisible" class="card p-3 mb-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">{{ formSanPham.maSanPham ? "Cập nhật Sản phẩm" : "Thêm Sản phẩm mới" }}</h5>
        <button type="button" class="btn-close" @click="closeSanPhamForm" aria-label="Close"></button>
      </div>
      <form @submit.prevent="saveSanPham">
        <div class="mb-3">
          <label class="form-label">Tên sản phẩm</label>
          <input v-model="formSanPham.tenSanPham" type="text" class="form-control" required />
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Mã SP</label>
            <input v-model="formSanPham.maSanPham" type="text" class="form-control" placeholder="Để trống để tự động sinh" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Danh mục</label>
            <select v-model.number="formSanPham.maDanhMuc" class="form-select" required>
              <option value="" disabled>-- Chọn danh mục --</option>
              <option v-for="opt in categoryOptions" :key="opt.value" :value="opt.value">
                {{ opt.label || ('#' + opt.value) }}
              </option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Thương hiệu</label>
            <select v-model="formSanPham.thuongHieu" class="form-select" required>
              <option value="" disabled>-- Chọn thương hiệu --</option>
              <option v-for="brand in brands" :key="brand" :value="brand">
                {{ brand || '—' }}
              </option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Số lượng tổng</label>
            <input v-model.number="formSanPham.soLuong" type="number" class="form-control" required />
          </div>
          <div class="col-md-4 mb-3">
             <label class="form-label">Trạng thái</label>
             <select v-model.number="formSanPham.trangThai" class="form-select">
               <option :value="1">Hoạt động</option>
               <option :value="0">Không hoạt động</option>
             </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Người tạo (UserID)</label>
            <input v-model="formSanPham.userID" type="text" class="form-control" />
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Mô tả</label>
          <textarea v-model="formSanPham.moTa" class="form-control" rows="2"></textarea>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i :class="formSanPham.maSanPham ? 'bi bi-check-circle' : 'bi bi-plus-circle'" class="me-2"></i>
            {{ formSanPham.maSanPham ? "Cập nhật" : "Thêm mới" }}
          </button>
          <button class="btn btn-secondary" type="button" @click="closeSanPhamForm">Hủy</button>
        </div>
      </form>
    </div>

    <ul class="nav nav-pills mb-3">
      <li class="nav-item">
        <button class="nav-link" :class="{ active: activeTab==='products' }" @click="activeTab='products'">
          Sản phẩm
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" :class="{ active: activeTab==='vtattrs' }" @click="activeTab='vtattrs'">
          Biến thể & Thuộc tính
          <span class="badge bg-light text-dark border ms-1">{{ allVariants.length }}</span>
          <span class="badge bg-light text-dark border ms-1">{{ allAttributes.length }}</span>
        </button>
      </li>
    </ul>

    <div class="card p-3 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4 col-md-12">
          <label class="form-label mb-1">Tìm kiếm</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input v-model="query" type="text" class="form-control" placeholder="Tên/Mã SP, Thương hiệu, Danh mục, SKU..." />
            <button class="btn btn-outline-secondary" type="button" @click="query = ''">Xóa</button>
          </div>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label mb-1">Lọc theo thương hiệu</label>
          <select v-model="brandFilter" class="form-select">
            <option value="">Tất cả thương hiệu</option>
            <option v-for="brand in brands" :key="brand" :value="brand">
              {{ brand || '—' }}
            </option>
          </select>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label mb-1">Lọc theo danh mục</label>
          <select v-model="categoryFilter" class="form-select">
            <option value="">Tất cả danh mục</option>
            <option v-for="opt in categoryOptions" :key="opt.value" :value="opt.label">
              {{ opt.label || ('#' + opt.value) }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div v-show="activeTab==='products'">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div v-if="sanPhams.length" class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 48px"></th>
                  <th role="button" @click="toggleSort('maSanPham')">Mã SP <SortIcon :active="sortBy==='maSanPham'" :dir="sortDir" /></th>
                  <th style="min-width: 320px;" role="button" @click="toggleSort('tenSanPham')">Tên sản phẩm <SortIcon :active="sortBy==='tenSanPham'" :dir="sortDir" /></th>
                  <th role="button" @click="toggleSort('thuongHieu')">Thương hiệu <SortIcon :active="sortBy==='thuongHieu'" :dir="sortDir" /></th>
                  <th role="button" @click="toggleSort('tenDanhMuc')">Danh mục <SortIcon :active="sortBy==='tenDanhMuc'" :dir="sortDir" /></th>
                  <th class="text-center" role="button" @click="toggleSort('soLuong')">Số lượng <SortIcon :active="sortBy==='soLuong'" :dir="sortDir" /></th>
                  <th class="text-center" role="button" @click="toggleSort('gia')">Giá niêm yết <SortIcon :active="sortBy==='gia'" :dir="sortDir" /></th>
                  <th>Trạng thái</th>
                  <th class="text-center">Biến thể</th>
                  <th style="width: 280px">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <template v-for="sp in paginated" :key="sp.maSanPham">
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-outline-secondary border-0" @click="toggleExpand(sp.maSanPham)" :title="expanded.has(sp.maSanPham) ? 'Thu gọn' : 'Xem biến thể'">
                        <i :class="expanded.has(sp.maSanPham) ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"></i>
                      </button>
                    </td>
                    <td><code>{{ sp.maSanPham }}</code></td>
                    <td>
                      <div class="d-flex flex-column">
                        <span class="fw-semibold">{{ sp.tenSanPham }}</span>
                        <small v-if="sp.moTa" class="text-muted d-none d-xl-inline">{{ sp.moTa }}</small>
                      </div>
                    </td>
                    <td><span class="badge bg-light text-dark border">{{ sp.thuongHieu || '—' }}</span></td>
                    <td>
                      <span class="badge bg-white text-dark border">{{ displayDanhMuc(sp) }}</span>
                    </td>
                    <td class="text-center">{{ sp.soLuong }}</td>
                    <td class="text-center">{{ Number(sp.gia || 0).toLocaleString() }}₫</td>
                    <td>
                       <span :class="sp.trangThai === 1 ? 'badge bg-success-subtle text-success border' : 'badge bg-secondary-subtle text-secondary border'">
                         {{ sp.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động' }}
                       </span>
                    </td>
                    <td class="text-center"><span class="badge rounded-pill bg-info text-dark">{{ (sp.bienTheList && sp.bienTheList.length) ? sp.bienTheList.length : 0 }}</span></td>
                    <td>
                      <div class="btn-group">
                        <button class="btn btn-sm btn-success" @click="openBienTheModal(sp)"><i class="bi bi-plus-lg me-1"></i> Biến thể</button>
                        <button class="btn btn-sm btn-warning" @click="openSanPhamForm(sp)"><i class="bi bi-pencil-square me-1"></i> Sửa</button>
                        <button class="btn btn-sm btn-danger" @click="removeSanPham(sp.maSanPham)"><i class="bi bi-trash me-1"></i> Xóa</button>
                      </div>
                    </td>
                  </tr>

                  <tr v-if="expanded.has(sp.maSanPham)">
                    <td colspan="10" class="p-3" style="background-color: var(--bs-gray-100);">
                      <div class="p-2">
                        <h6 class="mb-3">
                          <i class="bi bi-diagram-3 me-2"></i>
                          Các biến thể của sản phẩm: <span class="fw-normal">{{ sp.tenSanPham }}</span>
                        </h6>
                        <div v-if="sp.bienTheList && sp.bienTheList.length" class="table-responsive">
                          <table class="table table-bordered table-light mb-0">
                            <thead class="table-dark">
                              <tr>
                                <th>SKU</th>
                                <th>Giá bán</th>
                                <th>Giá gốc</th>
                                <th class="text-center">Tồn kho</th>
                                <th>Trạng thái</th>
                                <th>Thuộc tính</th>
                                <th style="width: 200px">Thao tác</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="bt in sp.bienTheList" :key="bt.maSKU">
                                <td><code>{{ bt.maSKU }}</code></td>
                                <td class="text-primary fw-semibold">{{ Number(bt.gia || 0).toLocaleString() }}₫</td>
                                <td class="text-muted"><del>{{ Number(bt.giaKhongKhuyenMai || 0).toLocaleString() }}₫</del></td>
                                <td class="text-center">{{ bt.soLuong }}</td>
                                <td>
                                  <span :class="bt.trangThai === 1 ? 'badge bg-success-subtle text-success border' : 'badge bg-secondary-subtle text-secondary border'">
                                    {{ bt.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động' }}
                                  </span>
                                </td>
                                <td>
                                  <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span v-for="tt in (bt.thuocTinhList || [])" :key="tt.maThuocTinh" class="badge bg-white text-dark border">
                                      {{ tt.tenThuocTinh }}: {{ tt.tenThuocTinhBienThe }}
                                    </span>
                                    <button class="btn btn-sm btn-outline-primary py-0 px-1" @click="openThuocTinhModal(bt)" title="Thêm thuộc tính">
                                      <i class="bi bi-plus"></i>
                                    </button>
                                  </div>
                                </td>
                                <td>
                                  <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-warning" @click="openBienTheModal(sp, bt)">Sửa</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="removeBienThe(bt.maSKU)">Xóa</button>
                                  </div>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div v-else class="alert alert-secondary py-2 mt-2 mb-0 d-flex justify-content-between align-items-center">
                          <span>Sản phẩm này chưa có biến thể nào.</span>
                           <button class="btn btn-sm btn-primary" @click="openBienTheModal(sp)">
                            <i class="bi bi-plus-circle me-1"></i>Thêm biến thể ngay
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div v-else class="alert alert-info m-3">
            Chưa có sản phẩm nào hoặc không tìm thấy kết quả phù hợp.
          </div>
        </div>
      </div>

      <div v-if="filtered.length > pageSize" class="d-flex align-items-center justify-content-between mt-3">
        <div class="text-muted small">
          Hiển thị {{ pageStart + 1 }}–{{ Math.min(pageStart + pageSize, filtered.length) }} trên tổng số {{ filtered.length }} sản phẩm
        </div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item" :class="{ disabled: page===1 }">
              <button class="page-link" @click="page = Math.max(1, page-1)">Trước</button>
            </li>
            <li class="page-item" v-for="p in totalPages" :key="p" :class="{ active: page===p }">
              <button class="page-link" @click="page = p">{{ p }}</button>
            </li>
            <li class="page-item" :class="{ disabled: page===totalPages }">
              <button class="page-link" @click="page = Math.min(totalPages, page+1)">Sau</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <!-- GỘP: Biến thể & Thuộc tính -->
    <div v-show="activeTab==='vtattrs'">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>SKU</th>
                  <th>Tên sản phẩm</th>
                  <th>Giá bán</th>
                  <th>Giá gốc</th>
                  <th>Tồn kho</th>
                  <th>Trạng thái</th>
                  <th>Thuộc tính</th>
                  <th style="width: 260px">Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in variantsFiltered" :key="row.maSKU">
                  <td><code>{{ row.maSKU }}</code></td>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-semibold">{{ row.tenSanPham }}</span>
                      <small class="text-muted">{{ row.maSanPham }}</small>
                    </div>
                  </td>
                  <td class="text-primary fw-semibold">{{ Number(row.gia || 0).toLocaleString() }}₫</td>
                  <td class="text-muted"><del>{{ Number(row.giaKhongKhuyenMai || 0).toLocaleString() }}₫</del></td>
                  <td>{{ row.soLuong }}</td>
                  <td>
                    <span :class="row.trangThai === 1 ? 'badge bg-success-subtle text-success border' : 'badge bg-secondary-subtle text-secondary border'">
                      {{ row.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động' }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                      <span v-for="tt in (row._btRef.thuocTinhList || [])" :key="tt.maThuocTinh" class="badge bg-white text-dark border">
                        {{ tt.tenThuocTinh }}: {{ tt.tenThuocTinhBienThe }}
                      </span>
                      <button class="btn btn-sm btn-outline-primary py-0 px-1" @click="openThuocTinhModal(row._btRef)" title="Thêm thuộc tính">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-warning" @click="openBienTheModal(row._productRef, row._btRef)">Sửa biến thể</button>
                      <button
                        v-for="tt in (row._btRef.thuocTinhList || [])"
                        :key="'edit-'+row.maSKU+'-'+tt.maThuocTinh"
                        class="btn btn-sm btn-outline-secondary"
                        @click="openThuocTinhModal(row._btRef, tt)"
                        title="Sửa thuộc tính"
                      >
                        TT: {{ tt.tenThuocTinh }}
                      </button>
                      <button class="btn btn-sm btn-outline-danger" @click="removeBienThe(row.maSKU)">Xóa biến thể</button>
                    </div>
                  </td>
                </tr>
                <tr v-if="variantsFiltered.length === 0">
                  <td colspan="8" class="text-center text-muted p-4">Không có biến thể phù hợp bộ lọc.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal thông báo -->
    <div class="modal fade" id="notifyModal" tabindex="-1" ref="notifyModalRef">
      <div class="modal-dialog">
        <div class="modal-content" :style="notifyGradientStyle">
          <div class="modal-header border-0 text-white">
            <h5 class="modal-title">
              {{ notify.type === 'success' ? 'Thành công' : 'Lỗi' }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-white">
            <p class="mb-2">{{ notify.message }}</p>
            <div class="small">Tự đóng sau: <strong>{{ notify.secondsLeft }}</strong>s</div>
            <div class="progress mt-2" style="height: 6px;">
              <div class="progress-bar" role="progressbar"
                   :style="{ width: notifyProgress + '%' }"
                   :aria-valuenow="notifyProgress" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Đóng ngay</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal biến thể -->
  <div class="modal fade" id="bienTheModal" tabindex="-1" ref="bienTheModalRef">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form @submit.prevent="saveBienThe">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ formBienThe.originalMaSKU ? 'Cập nhật biến thể' : 'Thêm biến thể mới' }}</h5>
              <div class="small text-muted mt-1">
                <i class="bi bi-diagram-3"></i>
                Thuộc sản phẩm:
                <span class="badge bg-secondary ms-1">{{ parentProduct.maSanPham || '—' }}</span>
                <span class="ms-2">{{ parentProduct.tenSanPham || '—' }}</span>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã SKU</label>
                <input v-model="formBienThe.maSKU" type="text" class="form-control" :disabled="!!formBienThe.originalMaSKU" required>
                <small v-if="!!formBienThe.originalMaSKU" class="form-text text-muted">Không thể thay đổi SKU.</small>
              </div>
               <div class="col-md-6 mb-3">
                <label class="form-label">Số lượng tồn kho</label>
                <input v-model.number="formBienThe.soLuong" type="number" class="form-control" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Giá bán (đã khuyến mãi)</label>
                <input v-model.number="formBienThe.gia" type="number" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Giá gốc (chưa khuyến mãi)</label>
                <input v-model.number="formBienThe.giaKhongKhuyenMai" type="number" class="form-control" required>
              </div>
            </div>
             <div class="row">
               <div class="col-md-6 mb-3">
                <label class="form-label">Trạng thái</label>
                <select v-model.number="formBienThe.trangThai" class="form-select">
                  <option :value="1">Hoạt động</option>
                  <option :value="0">Không hoạt động</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal thuộc tính -->
  <div class="modal fade" id="thuocTinhModal" tabindex="-1" ref="thuocTinhModalRef">
    <div class="modal-dialog">
      <div class="modal-content">
        <form @submit.prevent="saveThuocTinh">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ formThuocTinh.maThuocTinh ? 'Cập nhật thuộc tính' : 'Thêm thuộc tính mới' }}</h5>
              <div class="small text-muted mt-1">
                Thuộc SKU: <code class="ms-1">{{ currentBienTheSKU || '—' }}</code>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Tên thuộc tính (VD: Màu sắc, Kích cỡ)</label>
              <input v-model="formThuocTinh.tenThuocTinh" type="text" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Giá trị thuộc tính (VD: Đỏ, Xanh, XXL)</label>
              <input v-model="formThuocTinh.tenThuocTinhBienThe" type="text" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, nextTick, h } from "vue";
import { Modal } from 'bootstrap';

// API placeholders
import {
  fetchAllSanPhams, createSanPham, updateSanPham, deleteSanPham,
  createBienThe, updateBienThe,
  createThuocTinh, updateThuocTinh
} from "@/service/api";

// Sort icon component
const SortIcon = ({ active, dir }) => {
  if (!active) return h('i', { class: 'bi bi-arrow-down-up ms-1 text-black-50', style: 'font-size: 0.8em;' });
  return dir === 'asc'
    ? h('i', { class: 'bi bi-sort-up ms-1 text-primary' })
    : h('i', { class: 'bi bi-sort-down ms-1 text-primary' });
};

const activeTab = ref('products');

// Data
const sanPhams = ref([]);
const totalSanPhams = computed(() => sanPhams.value.length);

// UI state
const query = ref("");
const brandFilter = ref("");
const categoryFilter = ref("");
const sortBy = ref("tenSanPham");
const sortDir = ref("asc");

// Pagination
const page = ref(1);
const pageSize = ref(8);
const pageStart = computed(() => (page.value - 1) * pageSize.value);
const totalPages = computed(() => Math.max(1, Math.ceil(filtered.value.length / pageSize.value)));
const paginated = computed(() => sorted.value.slice(pageStart.value, pageStart.value + pageSize.value));

// Expand rows
const expanded = ref(new Set());
const toggleExpand = (id) => {
  if (expanded.value.has(id)) expanded.value.delete(id);
  else expanded.value.add(id);
};

// Brands (from products)
const brands = computed(() => {
  const set = new Set(sanPhams.value.map(sp => sp.thuongHieu || ""));
  return Array.from(set).sort((a, b) => a.localeCompare(b));
});

// Category options: from products (label = tenDanhMuc, value = maDanhMuc)
const categoryOptions = computed(() => {
  const map = new Map(); // key = maDanhMuc, value = tenDanhMuc
  sanPhams.value.forEach(sp => {
    const id = sp.maDanhMuc ?? "";
    const name = sp.tenDanhMuc ?? "";
    if (id !== "") {
      if (!map.has(id)) map.set(id, name);
      if (!map.get(id) && name) map.set(id, name);
    }
  });
  return Array.from(map.entries())
    .map(([value, label]) => ({ value, label }))
    .sort((a, b) => (a.label || '').localeCompare(b.label || ''));
});

// Display category name
const displayDanhMuc = (sp) => {
  const name = sp?.tenDanhMuc;
  if (name && name.trim() !== "") return name;
  const id = sp?.maDanhMuc;
  if (id === null || id === undefined || id === "") return "—";
  return `#${id}`;
};

// Search & filter
const normalized = (v) => (v ?? "").toString().toLowerCase();
const filtered = computed(() => {
  page.value = 1;
  return sanPhams.value.filter(sp => {
    const matchQuery =
      normalized(sp.tenSanPham).includes(normalized(query.value)) ||
      normalized(sp.maSanPham).includes(normalized(query.value)) ||
      normalized(sp.thuongHieu).includes(normalized(query.value)) ||
      normalized(sp.tenDanhMuc).includes(normalized(query.value)) ||
      normalized(sp.maDanhMuc).includes(normalized(query.value));
    const matchBrand = !brandFilter.value || sp.thuongHieu === brandFilter.value;
    const matchCategory =
      !categoryFilter.value ||
      (sp.tenDanhMuc || "") === categoryFilter.value ||
      (categoryOptions.value.find(o => o.label === categoryFilter.value)?.value === sp.maDanhMuc);
    return matchQuery && matchBrand && matchCategory;
  });
});

// Sort
const sorted = computed(() => {
  return [...filtered.value].sort((a, b) => {
    const va = a[sortBy.value];
    const vb = b[sortBy.value];
    if (typeof va === 'number' && typeof vb === 'number') {
      return sortDir.value === 'asc' ? va - vb : vb - va;
    }
    const sa = (va ?? '').toString().toLowerCase();
    const sb = (vb ?? '').toString().toLowerCase();
    return sortDir.value === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
  });
});

const toggleSort = (key) => {
  if (sortBy.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortBy.value = key;
    sortDir.value = 'asc';
  }
};

// Form sản phẩm
const isSanPhamFormVisible = ref(false);
const initialSanPhamState = {
  maSanPham: null, tenSanPham: "", moTa: "",
  soLuong: 0, trangThai: 1, maDanhMuc: '',
  userID: '', thuongHieu: ""
};
const formSanPham = ref({ ...initialSanPhamState });

const openSanPhamForm = (sp = null) => {
  formSanPham.value = sp ? { ...sp } : { ...initialSanPhamState };
  isSanPhamFormVisible.value = true;
  nextTick(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
};
const closeSanPhamForm = () => {
  isSanPhamFormVisible.value = false;
  formSanPham.value = { ...initialSanPhamState };
};

// Notify modal (gradient + countdown)
const notifyModalRef = ref(null);
let notifyModal = null;
const notify = ref({
  type: 'success',
  message: '',
  secondsLeft: 6,
});
let notifyTimer = null;
const notifyDuration = 6; // seconds
const notifyProgress = computed(() => ((notifyDuration - notify.value.secondsLeft) / notifyDuration) * 100);
const notifyGradientStyle = computed(() => {
  const start = notify.value.type === 'success' ? '#4caf50' : '#f44336';
  const end = notify.value.type === 'success' ? '#2e7d32' : '#b71c1c';
  return {
    background: `linear-gradient(135deg, ${start}, ${end})`,
    color: '#fff'
  };
});
const showNotify = (type, message) => {
  notify.value.type = type;
  notify.value.message = message;
  notify.value.secondsLeft = notifyDuration;
  notifyModal.show();
  if (notifyTimer) {
    clearInterval(notifyTimer);
    notifyTimer = null;
  }
  notifyTimer = setInterval(() => {
    notify.value.secondsLeft -= 1;
    if (notify.value.secondsLeft <= 0) {
      clearInterval(notifyTimer);
      notifyTimer = null;
      notifyModal.hide();
    }
  }, 1000);
};

// Save / Delete sản phẩm
const saveSanPham = async () => {
  try {
    const payload = { ...formSanPham.value };
    if (payload.maSanPham) {
      await updateSanPham(payload.maSanPham, payload);
      showNotify('success', 'Cập nhật sản phẩm thành công.');
    } else {
      await createSanPham(payload);
      showNotify('success', 'Thêm sản phẩm thành công.');
    }
    closeSanPhamForm();
    await loadSanPhams();
  } catch(error) {
    console.error("Lỗi khi lưu sản phẩm:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu sản phẩm.');
  }
};
const removeSanPham = async (id) => {
  if (confirm(`Bạn chắc chắn muốn xóa sản phẩm có mã [${id}]? Hành động này không thể hoàn tác.`)) {
    try {
      await deleteSanPham(id);
      await loadSanPhams();
      showNotify('success', 'Xóa sản phẩm thành công.');
    } catch(error) {
      console.error("Lỗi khi xóa sản phẩm:", error);
      showNotify('error', 'Đã xảy ra lỗi khi xóa sản phẩm.');
    }
  }
};

// Biến thể
const bienTheModalRef = ref(null);
let bienTheModal = null;
const initialBienTheState = { maSKU: '', originalMaSKU: null, gia: 0, giaKhongKhuyenMai: 0, soLuong: 0, trangThai: 1 };
const formBienThe = ref({ ...initialBienTheState });
const currentSanPhamId = ref(null);
const parentProduct = ref({});

const openBienTheModal = (sp, bt = null) => {
  currentSanPhamId.value = sp.maSanPham;
  parentProduct.value = sp;
  formBienThe.value = bt ? { ...bt, originalMaSKU: bt.maSKU } : { ...initialBienTheState };
  bienTheModal.show();
};
const saveBienThe = async () => {
  try {
    const dataToSave = { ...formBienThe.value };
    if (dataToSave.originalMaSKU) {
      await updateBienThe(dataToSave.originalMaSKU, dataToSave);
      showNotify('success', 'Cập nhật biến thể thành công.');
    } else {
      await createBienThe(currentSanPhamId.value, dataToSave);
      showNotify('success', 'Thêm biến thể thành công.');
    }
    bienTheModal.hide();
    await loadSanPhams();
  } catch(error) {
    console.error("Lỗi khi lưu biến thể:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu biến thể.');
  }
};
const removeBienThe = (sku) => {
  showNotify('error', `Chức năng xóa biến thể [${sku}] chưa có API.`);
};

// Thuộc tính
const thuocTinhModalRef = ref(null);
let thuocTinhModal = null;
const initialThuocTinhState = { maThuocTinh: null, tenThuocTinh: '', tenThuocTinhBienThe: '' };
const formThuocTinh = ref({ ...initialThuocTinhState });
const currentBienTheSKU = ref(null);

const openThuocTinhModal = (bt, tt = null) => {
  currentBienTheSKU.value = bt.maSKU;
  formThuocTinh.value = tt ? { ...tt } : { ...initialThuocTinhState };
  thuocTinhModal.show();
};
const saveThuocTinh = async () => {
  try {
    if (formThuocTinh.value.maThuocTinh) {
      await updateThuocTinh(formThuocTinh.value.maThuocTinh, formThuocTinh.value);
      showNotify('success', 'Cập nhật thuộc tính thành công.');
    } else {
      await createThuocTinh(currentBienTheSKU.value, formThuocTinh.value);
      showNotify('success', 'Thêm thuộc tính thành công.');
    }
    thuocTinhModal.hide();
    await loadSanPhams();
  } catch (error) {
    console.error("Lỗi khi lưu thuộc tính:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu thuộc tính.');
  }
};
const removeThuocTinh = (id) => {
  showNotify('error', `Chức năng xóa thuộc tính [${id}] chưa có API.`);
};

// Flatten lists
const allVariants = computed(() =>
  sanPhams.value.flatMap(sp =>
    (sp.bienTheList || []).map(bt => ({
      ...bt,
      maSanPham: sp.maSanPham,
      tenSanPham: sp.tenSanPham,
      thuongHieu: sp.thuongHieu,
      _productRef: sp,
      _btRef: bt,
    }))
  )
);
const variantsFiltered = computed(() =>
  allVariants.value.filter(row => {
    const matchQuery =
      normalized(row.maSKU).includes(normalized(query.value)) ||
      normalized(row.tenSanPham).includes(normalized(query.value)) ||
      normalized(row.maSanPham).includes(normalized(query.value));
    const matchBrand = !brandFilter.value || row.thuongHieu === brandFilter.value;
    // Category filter: dựa theo sản phẩm cha
    const matchCategory =
      !categoryFilter.value ||
      (row._productRef.tenDanhMuc || "") === categoryFilter.value ||
      (categoryOptions.value.find(o => o.label === categoryFilter.value)?.value === row._productRef.maDanhMuc);
    return matchQuery && matchBrand && matchCategory;
  })
);

const allAttributes = computed(() =>
  sanPhams.value.flatMap(sp =>
    (sp.bienTheList || []).flatMap(bt =>
      (bt.thuocTinhList || []).map(tt => ({
        ...tt,
        maSKU: bt.maSKU,
        maSanPham: sp.maSanPham,
        tenSanPham: sp.tenSanPham,
        _btRef: bt,
        _ttRef: tt,
      }))
    )
  )
);

// Load data
const loadSanPhams = async () => {
  try {
    sanPhams.value = await fetchAllSanPhams();
  } catch (error) {
    console.error("Lỗi khi tải danh sách sản phẩm:", error);
    showNotify('error', 'Lỗi tải dữ liệu sản phẩm.');
  }
};
const reload = () => {
  query.value = '';
  brandFilter.value = '';
  categoryFilter.value = '';
  loadSanPhams();
};

onMounted(() => {
  loadSanPhams();
  bienTheModal = new Modal(bienTheModalRef.value);
  thuocTinhModal = new Modal(thuocTinhModalRef.value);
  notifyModal = new Modal(notifyModalRef.value, { backdrop: 'static' });
});
</script>


<!-- <template>
  <div class="container-fluid py-4 px-md-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0">Quản lý Sản phẩm</h2>
        <span class="badge bg-primary-subtle text-primary border fs-6">
          {{ totalSanPhams }} sản phẩm
        </span>
      </div>
      <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
        <button class="btn btn-outline-secondary" @click="reload">
          <i class="bi bi-arrow-clockwise me-2"></i>Tải lại
        </button>
        <button class="btn btn-primary" @click="openSanPhamForm()">
          <i class="bi bi-plus-circle me-2"></i>Thêm sản phẩm mới
        </button>
      </div>
    </div>

    <div v-if="isSanPhamFormVisible" class="card p-3 mb-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">{{ formSanPham.maSanPham ? "Cập nhật Sản phẩm" : "Thêm Sản phẩm mới" }}</h5>
        <button type="button" class="btn-close" @click="closeSanPhamForm" aria-label="Close"></button>
      </div>
      <form @submit.prevent="saveSanPham">
        <div class="mb-3">
          <label class="form-label">Tên sản phẩm</label>
          <input v-model="formSanPham.tenSanPham" type="text" class="form-control" required />
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Danh mục</label>
            <select v-model.number="formSanPham.maDanhMuc" class="form-select" required>
              <option value="" disabled>-- Chọn danh mục --</option>
              <option v-for="opt in categoryOptions" :key="opt.value" :value="opt.value">
                {{ opt.label || ('#' + opt.value) }}
              </option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Thương hiệu</label>
            <input v-model="formSanPham.thuongHieu" type="text" class="form-control" required />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
             <label class="form-label">Trạng thái</label>
             <select v-model.number="formSanPham.trangThai" class="form-select">
               <option :value="1">Hoạt động</option>
               <option :value="0">Không hoạt động</option>
             </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Người tạo (UserID)</label>
            <input v-model.number="formSanPham.userId" type="number" class="form-control" required />
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Mô tả</label>
          <textarea v-model="formSanPham.moTa" class="form-control" rows="2"></textarea>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i :class="formSanPham.maSanPham ? 'bi bi-check-circle' : 'bi bi-plus-circle'" class="me-2"></i>
            {{ formSanPham.maSanPham ? "Cập nhật" : "Thêm mới" }}
          </button>
          <button class="btn btn-secondary" type="button" @click="closeSanPhamForm">Hủy</button>
        </div>
      </form>
    </div>

    <div class="card p-3 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4 col-md-12">
          <label class="form-label mb-1">Tìm kiếm</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input v-model="query" type="text" class="form-control" placeholder="Tên/Mã SP, Thương hiệu, SKU..." />
            <button class="btn btn-outline-secondary" type="button" @click="query = ''">Xóa</button>
          </div>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label mb-1">Lọc theo thương hiệu</label>
          <select v-model="brandFilter" class="form-select">
            <option value="">Tất cả thương hiệu</option>
            <option v-for="brand in brands" :key="brand" :value="brand">
              {{ brand || '—' }}
            </option>
          </select>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label mb-1">Lọc theo danh mục</label>
          <select v-model="categoryFilter" class="form-select">
            <option value="">Tất cả danh mục</option>
            <option v-for="opt in categoryOptions" :key="opt.value" :value="opt.value">
              {{ opt.label || ('#' + opt.value) }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div v-if="filtered.length" class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 48px"></th>
                <th role="button" @click="toggleSort('maSanPham')">Mã SP <SortIcon :active="sortBy==='maSanPham'" :dir="sortDir" /></th>
                <th style="min-width: 320px;" role="button" @click="toggleSort('tenSanPham')">Tên sản phẩm <SortIcon :active="sortBy==='tenSanPham'" :dir="sortDir" /></th>
                <th role="button" @click="toggleSort('thuongHieu')">Thương hiệu <SortIcon :active="sortBy==='thuongHieu'" :dir="sortDir" /></th>
                <th role="button" @click="toggleSort('tenDanhMuc')">Danh mục <SortIcon :active="sortBy==='tenDanhMuc'" :dir="sortDir" /></th>
                <th class="text-center" role="button" @click="toggleSort('soLuong')">Tổng SL <SortIcon :active="sortBy==='soLuong'" :dir="sortDir" /></th>
                <th class="text-center" role="button" @click="toggleSort('gia')">Giá thấp nhất <SortIcon :active="sortBy==='gia'" :dir="sortDir" /></th>
                <th>Trạng thái</th>
                <th class="text-center">Biến thể</th>
                <th style="width: 280px">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <template v-for="sp in paginated" :key="sp.maSanPham">
                <tr>
                  <td>
                    <button class="btn btn-sm btn-outline-secondary border-0" @click="toggleExpand(sp.maSanPham)" :title="expanded.has(sp.maSanPham) ? 'Thu gọn' : 'Xem biến thể'">
                      <i :class="expanded.has(sp.maSanPham) ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"></i>
                    </button>
                  </td>
                  <td><code>{{ sp.maSanPham }}</code></td>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-semibold">{{ sp.tenSanPham }}</span>
                      <small v-if="sp.moTa" class="text-muted d-none d-xl-inline">{{ sp.moTa }}</small>
                    </div>
                  </td>
                  <td><span class="badge bg-light text-dark border">{{ sp.thuongHieu || '—' }}</span></td>
                  <td>
                    <span class="badge bg-white text-dark border">{{ displayDanhMuc(sp) }}</span>
                  </td>
                  <td class="text-center">{{ sp.soLuong }}</td>
                  <td class="text-center">{{ Number(sp.gia || 0).toLocaleString() }}₫</td>
                  <td>
                    <span :class="sp.trangThai === 1 ? 'badge bg-success-subtle text-success border' : 'badge bg-secondary-subtle text-secondary border'">
                      {{ sp.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động' }}
                    </span>
                  </td>
                  <td class="text-center"><span class="badge rounded-pill bg-info text-dark">{{ (sp.bienTheList && sp.bienTheList.length) ? sp.bienTheList.length : 0 }}</span></td>
                  <td>
                    <div class="btn-group">
                      <button class="btn btn-sm btn-success" @click="openBienTheModal(sp)"><i class="bi bi-plus-lg me-1"></i> Biến thể</button>
                      <button class="btn btn-sm btn-warning" @click="openSanPhamForm(sp)"><i class="bi bi-pencil-square me-1"></i> Sửa SP</button>
                      
                    </div>
                  </td>
                </tr>

                <tr v-if="expanded.has(sp.maSanPham)">
                  <td colspan="10" class="p-3" style="background-color: var(--bs-gray-100);">
                    <div class="p-2">
                      <h6 class="mb-3">
                        <i class="bi bi-diagram-3 me-2"></i>
                        Các biến thể của sản phẩm: <span class="fw-normal">{{ sp.tenSanPham }}</span>
                      </h6>
                      <div v-if="sp.bienTheList && sp.bienTheList.length" class="table-responsive">
                        <table class="table table-bordered table-light mb-0">
                          <thead class="table-dark">
                            <tr>
                              <th>SKU</th>
                              <th>Giá bán</th>
                              <th>Giá gốc</th>
                              <th class="text-center">Tồn kho</th>
                              <th>Trạng thái</th>
                              <th>Thuộc tính</th>
                              <th style="width: 200px">Thao tác</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr v-for="bt in sp.bienTheList" :key="bt.maSKU">
                              <td><code>{{ bt.maSKU }}</code></td>
                              <td class="text-primary fw-semibold">{{ Number(bt.gia || 0).toLocaleString() }}₫</td>
                              <td class="text-muted"><del>{{ Number(bt.giaKhongKhuyenMai || 0).toLocaleString() }}₫</del></td>
                              <td class="text-center">{{ bt.soLuong }}</td>
                              <td>
                                <span :class="bt.trangThai === 1 ? 'badge bg-success-subtle text-success border' : 'badge bg-secondary-subtle text-secondary border'">
                                  {{ bt.trangThai === 1 ? 'Hoạt động' : 'Không hoạt động' }}
                                </span>
                              </td>
                              <td>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                  <span v-for="tt in (bt.thuocTinhList || [])" :key="tt.maThuocTinh" class="badge bg-white text-dark border position-relative pe-4">
                                    {{ tt.tenThuocTinh }}: {{ tt.tenThuocTinhBienThe }}
                                    <button @click="removeThuocTinh(sp, bt, tt.maThuocTinh)" class="btn-close btn-sm position-absolute top-50 translate-middle-y" style="right: 2px;" title="Xóa thuộc tính"></button>
                                  </span>
                                  <button class="btn btn-sm btn-outline-primary py-0 px-1" @click="openThuocTinhModal(sp, bt)" title="Thêm thuộc tính">
                                    <i class="bi bi-plus"></i>
                                  </button>
                                </div>
                              </td>
                              <td>
                                <div class="btn-group">
                                  <button class="btn btn-sm btn-outline-warning" @click="openBienTheModal(sp, bt)">Sửa</button>
                                  <button class="btn btn-sm btn-outline-danger" @click="removeBienThe(bt.maSKU)">Xóa</button>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <div v-else class="alert alert-secondary py-2 mt-2 mb-0 d-flex justify-content-between align-items-center">
                        <span>Sản phẩm này chưa có biến thể nào.</span>
                          <button class="btn btn-sm btn-primary" @click="openBienTheModal(sp)">
                          <i class="bi bi-plus-circle me-1"></i>Thêm biến thể ngay
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div v-else class="alert alert-info m-3">
          Chưa có sản phẩm nào hoặc không tìm thấy kết quả phù hợp.
        </div>
      </div>
    </div>

    <div v-if="filtered.length > pageSize" class="d-flex align-items-center justify-content-between mt-3">
      <div class="text-muted small">
        Hiển thị {{ pageStart + 1 }}–{{ Math.min(pageStart + pageSize, filtered.length) }} trên tổng số {{ filtered.length }} sản phẩm
      </div>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item" :class="{ disabled: page===1 }">
            <button class="page-link" @click="page = Math.max(1, page-1)">Trước</button>
          </li>
          <li class="page-item" v-for="p in totalPages" :key="p" :class="{ active: page===p }">
            <button class="page-link" @click="page = p">{{ p }}</button>
          </li>
          <li class="page-item" :class="{ disabled: page===totalPages }">
            <button class="page-link" @click="page = Math.min(totalPages, page+1)">Sau</button>
          </li>
        </ul>
      </nav>
    </div>

  </div>

  <div class="modal fade" id="bienTheModal" tabindex="-1" ref="bienTheModalRef">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form @submit.prevent="saveBienThe">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ formBienThe.originalMaSKU ? 'Cập nhật biến thể' : 'Thêm biến thể mới' }}</h5>
              <div class="small text-muted mt-1">
                <i class="bi bi-diagram-3"></i>
                Thuộc sản phẩm:
                <span class="badge bg-secondary ms-1">{{ parentProduct.maSanPham || '—' }}</span>
                <span class="ms-2">{{ parentProduct.tenSanPham || '—' }}</span>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã SKU</label>
                <input v-model="formBienThe.maSKU" type="text" class="form-control" :disabled="!!formBienThe.originalMaSKU" required>
                <small v-if="!!formBienThe.originalMaSKU" class="form-text text-muted">Không thể thay đổi SKU.</small>
              </div>
               <div class="col-md-6 mb-3">
                <label class="form-label">Số lượng tồn kho</label>
                <input v-model.number="formBienThe.soLuong" type="number" class="form-control" min="0" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Giá bán (đã khuyến mãi)</label>
                <input v-model.number="formBienThe.gia" type="number" class="form-control" min="0" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Giá gốc (chưa khuyến mãi)</label>
                <input v-model.number="formBienThe.giaKhongKhuyenMai" type="number" class="form-control" min="0" required>
              </div>
            </div>
             <div class="row">
               <div class="col-md-6 mb-3">
                <label class="form-label">Trạng thái</label>
                <select v-model.number="formBienThe.trangThai" class="form-select">
                  <option :value="1">Hoạt động</option>
                  <option :value="0">Không hoạt động</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="thuocTinhModal" tabindex="-1" ref="thuocTinhModalRef">
    <div class="modal-dialog">
      <div class="modal-content">
        <form @submit.prevent="saveThuocTinh">
          <div class="modal-header">
            <div>
              <h5 class="modal-title">{{ formThuocTinh.maThuocTinh ? 'Cập nhật thuộc tính' : 'Thêm thuộc tính mới' }}</h5>
              <div class="small text-muted mt-1">
                Thuộc SKU: <code class="ms-1">{{ currentBienTheSKU || '—' }}</code>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Tên thuộc tính (VD: Màu sắc, Kích cỡ)</label>
              <input v-model="formThuocTinh.tenThuocTinh" type="text" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Giá trị thuộc tính (VD: Đỏ, Xanh, XXL)</label>
              <input v-model="formThuocTinh.tenThuocTinhBienThe" type="text" class="form-control" required>
            </div>
             <div class="mb-3">
                <label class="form-label">Trạng thái</label>
                <select v-model.number="formThuocTinh.trangThai" class="form-select">
                  <option :value="1">Hoạt động</option>
                  <option :value="0">Không hoạt động</option>
                </select>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="notifyModal" tabindex="-1" ref="notifyModalRef">
    <div class="modal-dialog">
      <div class="modal-content" :style="notifyGradientStyle">
        <div class="modal-header border-0 text-white">
          <h5 class="modal-title">
            {{ notify.type === 'success' ? 'Thành công' : 'Lỗi' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-white">
          <p class="mb-2">{{ notify.message }}</p>
          <div class="small">Tự đóng sau: <strong>{{ notify.secondsLeft }}</strong>s</div>
          <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar" role="progressbar"
                 :style="{ width: notifyProgress + '%' }"
                 :aria-valuenow="notifyProgress" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Đóng ngay</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, nextTick, h } from "vue";
import { Modal } from 'bootstrap';
import {
  fetchAllAdminProducts, createAdminProduct, updateAdminProduct, deleteAdminProduct,
  deleteAdminVariant, deleteAdminAttribute
} from "@/service/api";

// Sort icon component
const SortIcon = ({ active, dir }) => {
  if (!active) return h('i', { class: 'bi bi-arrow-down-up ms-1 text-black-50', style: 'font-size: 0.8em;' });
  return dir === 'asc'
    ? h('i', { class: 'bi bi-sort-up ms-1 text-primary' })
    : h('i', { class: 'bi bi-sort-down ms-1 text-primary' });
};

// Data
const sanPhams = ref([]);
const totalSanPhams = computed(() => sanPhams.value.length);

// UI state
const query = ref("");
const brandFilter = ref("");
const categoryFilter = ref("");
const sortBy = ref("tenSanPham");
const sortDir = ref("asc");

// Pagination
const page = ref(1);
const pageSize = ref(8);
const pageStart = computed(() => (page.value - 1) * pageSize.value);
const totalPages = computed(() => Math.max(1, Math.ceil(filtered.value.length / pageSize.value)));
const paginated = computed(() => sorted.value.slice(pageStart.value, pageStart.value + pageSize.value));

// Expand rows
const expanded = ref(new Set());
const toggleExpand = (id) => {
  if (expanded.value.has(id)) expanded.value.delete(id);
  else expanded.value.add(id);
};

// Computed properties
const brands = computed(() => Array.from(new Set(sanPhams.value.map(sp => sp.thuongHieu || ""))).sort());
const categoryOptions = computed(() => {
  const map = new Map();
  sanPhams.value.forEach(sp => {
    if (sp.maDanhMuc) map.set(sp.maDanhMuc, sp.tenDanhMuc || `Danh mục #${sp.maDanhMuc}`);
  });
  return Array.from(map.entries()).map(([value, label]) => ({ value, label })).sort((a, b) => a.label.localeCompare(b.label));
});

const displayDanhMuc = (sp) => sp.tenDanhMuc || (sp.maDanhMuc ? `#${sp.maDanhMuc}` : '—');

// Search & filter
const normalized = (v) => (v ?? "").toString().toLowerCase();
const filtered = computed(() => {
  page.value = 1;
  const q = normalized(query.value);
  return sanPhams.value.filter(sp => {
    const matchQuery = !q ||
      normalized(sp.tenSanPham).includes(q) ||
      normalized(sp.maSanPham).includes(q) ||
      normalized(sp.thuongHieu).includes(q) ||
      (sp.bienTheList || []).some(bt => normalized(bt.maSKU).includes(q));
    const matchBrand = !brandFilter.value || sp.thuongHieu === brandFilter.value;
    const matchCategory = !categoryFilter.value || sp.maDanhMuc === categoryFilter.value;
    return matchQuery && matchBrand && matchCategory;
  });
});

// Sort
const sorted = computed(() => {
  return [...filtered.value].sort((a, b) => {
    const va = a[sortBy.value];
    const vb = b[sortBy.value];
    if (typeof va === 'number' && typeof vb === 'number') {
      return sortDir.value === 'asc' ? va - vb : vb - va;
    }
    const sa = normalized(va);
    const sb = normalized(vb);
    return sortDir.value === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
  });
});

const toggleSort = (key) => {
  if (sortBy.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortBy.value = key;
    sortDir.value = 'asc';
  }
};

// Form sản phẩm
const isSanPhamFormVisible = ref(false);
const initialSanPhamState = { maSanPham: null, tenSanPham: "", moTa: "", trangThai: 1, maDanhMuc: '', userId: 1, thuongHieu: "", bienTheList: [] };
const formSanPham = ref({ ...initialSanPhamState });

const openSanPhamForm = (sp = null) => {
  formSanPham.value = sp ? JSON.parse(JSON.stringify(sp)) : { ...initialSanPhamState };
  isSanPhamFormVisible.value = true;
  nextTick(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
};
const closeSanPhamForm = () => { isSanPhamFormVisible.value = false; };

// Modal thông báo
const notifyModalRef = ref(null);
let notifyModal = null;
const notify = ref({ type: 'success', message: '', secondsLeft: 5 });
let notifyTimer = null;
const notifyDuration = 5;
const notifyProgress = computed(() => (notify.value.secondsLeft / notifyDuration) * 100);
const notifyGradientStyle = computed(() => {
  const [start, end] = notify.value.type === 'success' ? ['#4caf50', '#2e7d32'] : ['#f44336', '#b71c1c'];
  return { background: `linear-gradient(135deg, ${start}, ${end})`, color: '#fff' };
});

const showNotify = (type, message) => {
  notify.value = { type, message, secondsLeft: notifyDuration };
  notifyModal.show();
  clearInterval(notifyTimer);
  notifyTimer = setInterval(() => {
    notify.value.secondsLeft--;
    if (notify.value.secondsLeft <= 0) {
      clearInterval(notifyTimer);
      notifyModal.hide();
    }
  }, 1000);
};

// API Calls
const loadSanPhams = async () => {
  try {
    sanPhams.value = await fetchAllAdminProducts();
  } catch (error) {
    console.error("Lỗi khi tải danh sách sản phẩm:", error);
    showNotify('error', 'Lỗi tải dữ liệu sản phẩm.');
  }
};

const reload = () => {
  query.value = '';
  brandFilter.value = '';
  categoryFilter.value = '';
  loadSanPhams();
};

const saveSanPham = async () => {
  try {
    const payload = formSanPham.value;
    if (payload.maSanPham) {
      const updatedProduct = await updateAdminProduct(payload.maSanPham, payload);
      const index = sanPhams.value.findIndex(p => p.maSanPham === updatedProduct.maSanPham);
      if (index !== -1) sanPhams.value[index] = updatedProduct;
      showNotify('success', 'Cập nhật sản phẩm thành công.');
    } else {
      const newProduct = await createAdminProduct(payload);
      sanPhams.value.unshift(newProduct);
      showNotify('success', 'Thêm sản phẩm thành công.');
    }
    closeSanPhamForm();
  } catch(error) {
    console.error("Lỗi khi lưu sản phẩm:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu sản phẩm.');
  }
};

const removeSanPham = async (id) => {
  if (confirm(`Bạn chắc chắn muốn xóa sản phẩm có mã [${id}]? Hành động này sẽ xóa cả các biến thể con.`)) {
    try {
      await deleteAdminProduct(id);
      await loadSanPhams();
      showNotify('success', 'Xóa sản phẩm thành công.');
    } catch(error) {
      console.error("Lỗi khi xóa sản phẩm:", error);
      showNotify('error', 'Đã xảy ra lỗi khi xóa sản phẩm.');
    }
  }
};

// Biến thể
const bienTheModalRef = ref(null);
let bienTheModal = null;
const initialBienTheState = { maSKU: '', originalMaSKU: null, gia: 0, giaKhongKhuyenMai: 0, soLuong: 0, trangThai: 1, thuocTinhList: [] };
const formBienThe = ref({ ...initialBienTheState });
const parentProduct = ref({});

const openBienTheModal = (sp, bt = null) => {
  parentProduct.value = sp;
  formBienThe.value = bt ? JSON.parse(JSON.stringify({ ...bt, originalMaSKU: bt.maSKU })) : { ...initialBienTheState };
  bienTheModal.show();
};

const saveBienThe = async () => {
  try {
    const productToUpdate = sanPhams.value.find(p => p.maSanPham === parentProduct.value.maSanPham);
    if (!productToUpdate) throw new Error("Không tìm thấy sản phẩm cha!");

    // ✨ BƯỚC 1: Tạo payload sạch, loại bỏ trường originalMaSKU
    const { originalMaSKU, ...variantData } = formBienThe.value;

    if (originalMaSKU) { // Cập nhật biến thể cũ
      const variantIndex = productToUpdate.bienTheList.findIndex(v => v.maSKU === originalMaSKU);
      if (variantIndex !== -1) {
        // ✨ BƯỚC 2: Gán payload sạch vào vị trí cũ
        productToUpdate.bienTheList[variantIndex] = variantData;
      }
    } else { // Thêm biến thể mới
      if (!productToUpdate.bienTheList) productToUpdate.bienTheList = [];
       // ✨ BƯỚC 2: Đẩy payload sạch vào danh sách
      productToUpdate.bienTheList.push(variantData);
    }

    const updatedProduct = await updateAdminProduct(productToUpdate.maSanPham, productToUpdate);
    const index = sanPhams.value.findIndex(p => p.maSanPham === updatedProduct.maSanPham);
    if (index !== -1) sanPhams.value[index] = updatedProduct;
    
    bienTheModal.hide();
    showNotify('success', 'Lưu biến thể thành công.');
  } catch(error) {
    console.error("Lỗi khi lưu biến thể:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu biến thể.');
  }
};

const removeBienThe = async (sku) => {
  if (confirm(`Bạn chắc chắn muốn xóa biến thể có SKU [${sku}]?`)) {
    try {
      await deleteAdminVariant(sku);
      await loadSanPhams();
      showNotify('success', 'Xóa biến thể thành công.');
    } catch(error) {
      console.error("Lỗi khi xóa biến thể:", error);
      showNotify('error', 'Đã xảy ra lỗi khi xóa biến thể.');
    }
  }
};

// Thuộc tính
const thuocTinhModalRef = ref(null);
let thuocTinhModal = null;
const initialThuocTinhState = { maThuocTinh: null, tenThuocTinh: '', tenThuocTinhBienThe: '', trangThai: 1 };
const formThuocTinh = ref({ ...initialThuocTinhState });
const currentBienTheSKU = ref(null);

const openThuocTinhModal = (sp, bt, tt = null) => {
  parentProduct.value = sp;
  currentBienTheSKU.value = bt.maSKU;
  formThuocTinh.value = tt ? JSON.parse(JSON.stringify(tt)) : { ...initialThuocTinhState };
  thuocTinhModal.show();
};

const saveThuocTinh = async () => {
  try {
    const productToUpdate = sanPhams.value.find(p => p.maSanPham === parentProduct.value.maSanPham);
    if (!productToUpdate) throw new Error("Không tìm thấy sản phẩm cha!");
    
    const variantToUpdate = productToUpdate.bienTheList.find(v => v.maSKU === currentBienTheSKU.value);
    if (!variantToUpdate) throw new Error("Không tìm thấy biến thể cha!");

    const attributeData = formThuocTinh.value; // Dữ liệu thuộc tính sạch, không cần xử lý thêm

    if (attributeData.maThuocTinh) { // Cập nhật thuộc tính
      const attrIndex = variantToUpdate.thuocTinhList.findIndex(a => a.maThuocTinh === attributeData.maThuocTinh);
      if (attrIndex !== -1) variantToUpdate.thuocTinhList[attrIndex] = attributeData;
    } else { // Thêm thuộc tính
      if (!variantToUpdate.thuocTinhList) variantToUpdate.thuocTinhList = [];
      variantToUpdate.thuocTinhList.push(attributeData);
    }

    const updatedProduct = await updateAdminProduct(productToUpdate.maSanPham, productToUpdate);
    const index = sanPhams.value.findIndex(p => p.maSanPham === updatedProduct.maSanPham);
    if (index !== -1) sanPhams.value[index] = updatedProduct;

    thuocTinhModal.hide();
    showNotify('success', 'Lưu thuộc tính thành công.');
  } catch (error) {
    console.error("Lỗi khi lưu thuộc tính:", error);
    showNotify('error', 'Đã xảy ra lỗi khi lưu thuộc tính.');
  }
};

const removeThuocTinh = async (parentSp, parentBt, attributeId) => {
  if (confirm(`Bạn chắc chắn muốn xóa thuộc tính này?`)) {
    try {
      await deleteAdminAttribute(attributeId);
      const updatedProduct = await fetchAllAdminProducts().then(all => all.find(p => p.maSanPham === parentSp.maSanPham));
      if (updatedProduct) {
        const index = sanPhams.value.findIndex(p => p.maSanPham === updatedProduct.maSanPham);
        if (index !== -1) sanPhams.value[index] = updatedProduct;
      } else {
        await loadSanPhams();
      }
      showNotify('success', 'Xóa thuộc tính thành công.');
    } catch(error) {
      console.error("Lỗi khi xóa thuộc tính:", error);
      showNotify('error', 'Đã xảy ra lỗi khi xóa thuộc tính.');
    }
  }
};

onMounted(() => {
  loadSanPhams();
  bienTheModal = new Modal(bienTheModalRef.value);
  thuocTinhModal = new Modal(thuocTinhModalRef.value);
  notifyModal = new Modal(notifyModalRef.value, { backdrop: 'static' });
});
</script> -->